<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1 id="welcome-message">Chat</h1>
            <button onclick="logout()" class="btn btn-logout">Logout</button>
        </header>
        <div class="main-layout">
            <div id="admin-panel" class="admin-panel" style="display: none;">
                <h2>Users</h2>
                <ul id="user-list"></ul>
            </div>
            <div class="chat-area">
                <div class="messages-box" id="messages-box">
                    <div class="chat-area-welcome">
                        <h2 id="chat-title">Select a user to start chatting</h2>
                    </div>
                </div>
                <div class="message-input-area" id="message-input-area" style="display: none;">
                    <input type="text" id="message-input" placeholder="Type a message..." class="input-field">
                    <button onclick="sendMessage()" class="btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const welcomeMessage = document.getElementById('welcome-message');
        const adminPanel = document.getElementById('admin-panel');
        const userList = document.getElementById('user-list');
        const messagesBox = document.getElementById('messages-box');
        const messageInputArea = document.getElementById('message-input-area');
        const messageInput = document.getElementById('message-input');
        const chatTitle = document.getElementById('chat-title');
        
        let currentUser = null;
        let selectedUserId = null;
        let adminId = null;
        let socket;
        
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/index.html';
                return;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload.user;
                welcomeMessage.textContent = `Welcome, ${currentUser.username}`;
                setupSocket(token);
                if (currentUser.isAdmin) {
                    adminPanel.style.display = 'block';
                    fetchUsers(token);
                } else {
                    chatTitle.textContent = "Chat with Admin";
                    messageInputArea.style.display = 'flex';
                    selectedUserId = 'admin'; 
                    fetchChatHistory(token);
                }
            } catch (e) {
                console.error("Invalid token:", e);
                logout();
            }
        });

        function setupSocket(token) {
            socket = io({ auth: { token } });

            socket.on('receiveMessage', (message) => {
                const otherPartyId = currentUser.isAdmin ? selectedUserId : adminId;
                if ((message.senderId === otherPartyId && message.recipientId === currentUser.id) || 
                    (message.senderId === currentUser.id && message.recipientId === otherPartyId)) {
                    displayMessage(message);
                }
            });

            socket.on('messagingError', ({ error }) => {
                alert(`Error: ${error}`); // For debugging, shows clear errors
            });

            socket.on('userStatus', ({ userId, online }) => {
                const userElement = document.querySelector(`li[data-user-id="${userId}"] .status-dot`);
                if (userElement) userElement.classList.toggle('online', online);
            });

            socket.on('onlineUsers', (onlineUserIds) => {
                userList.querySelectorAll('li').forEach(li => {
                    const dot = li.querySelector('.status-dot');
                    if (dot) dot.classList.toggle('online', onlineUserIds.includes(li.dataset.userId));
                });
            });
        }

        async function fetchUsers(token) {
            try {
                const res = await fetch('/api/users', { headers: { 'x-auth-token': token } });
                if (!res.ok) throw new Error('Failed to fetch users');
                const users = await res.json();
                userList.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.dataset.userId = user._id;
                    li.dataset.username = user.username;
                    li.innerHTML = `<span>${user.username}</span><span class="status-dot"></span>`;
                    li.onclick = () => selectUser(li);
                    userList.appendChild(li);
                });
            } catch (error) { console.error(error); }
        }
        
        function selectUser(li) {
            const currentSelected = document.querySelector('#user-list li.selected');
            if (currentSelected) currentSelected.classList.remove('selected');
            li.classList.add('selected');
            selectedUserId = li.dataset.userId;
            chatTitle.textContent = `Chat with ${li.dataset.username}`;
            messageInputArea.style.display = 'flex';
            fetchChatHistory(localStorage.getItem('token'));
        }
        
        async function fetchChatHistory(token) {
            if (!selectedUserId) return;
            messagesBox.innerHTML = '<p class="info-text">Loading history...</p>';
            try {
                const res = await fetch(`/api/messages/${selectedUserId}`, { headers: { 'x-auth-token': token } });
                if (!res.ok) throw new Error(`Server responded with status: ${res.status}`);
                const response = await res.json();
                const messages = response.messages;
                if (!currentUser.isAdmin) adminId = response.adminId;
                
                messagesBox.innerHTML = ''; 
                if (!messages || messages.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'chat-area-welcome';
                    emptyState.innerHTML = `<h2>This is the beginning of your conversation.</h2><p>Messages you send will appear here.</p>`;
                    messagesBox.appendChild(emptyState);
                } else {
                    messages.forEach(displayMessage);
                }
            } catch (error) {
                console.error("Failed to fetch chat history:", error);
                messagesBox.innerHTML = `<div class="chat-area-welcome"><h2>Something went wrong.</h2><p>We couldn't load the message history. The admin account may not be configured correctly on the server.</p></div>`;
            }
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text && socket) {
                const recipientId = currentUser.isAdmin ? selectedUserId : null;
                socket.emit('sendMessage', { recipientId, text });
                messageInput.value = '';
            }
        }

        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        function displayMessage(message) {
            const welcomeBox = messagesBox.querySelector('.chat-area-welcome');
            if (welcomeBox) welcomeBox.remove();
            const messageType = message.senderId === currentUser.id ? 'sent' : 'received';
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', messageType);
            const textP = document.createElement('p');
            textP.classList.add('msg-text');
            textP.textContent = message.text;
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('msg-time');
            timeSpan.textContent = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            msgDiv.appendChild(textP);
            msgDiv.appendChild(timeSpan);
            messagesBox.appendChild(msgDiv); 
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }
    </script>
</body>
</html>

