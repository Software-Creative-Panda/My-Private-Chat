<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1 id="welcome-message">Chat</h1>
            <button onclick="logout()" class="btn btn-logout">Logout</button>
        </header>
        <div class="main-layout">
            <!-- Admin Panel (will be hidden for regular users) -->
            <div id="admin-panel" class="admin-panel" style="display: none;">
                <h2>Users</h2>
                <ul id="user-list"></ul>
            </div>
            <!-- Chat Area -->
            <div class="chat-area">
                <div class="messages-box" id="messages-box">
                    <div class="chat-area-welcome">
                        <h2 id="chat-title">Select a user to start chatting</h2>
                    </div>
                </div>
                <div class="message-input-area" id="message-input-area" style="display: none;">
                    <input type="text" id="message-input" placeholder="Type a message..." class="input-field">
                    <button onclick="sendMessage()" class="btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- DOM Elements ---
        const welcomeMessage = document.getElementById('welcome-message');
        const adminPanel = document.getElementById('admin-panel');
        const userList = document.getElementById('user-list');
        const messagesBox = document.getElementById('messages-box');
        const messageInputArea = document.getElementById('message-input-area');
        const messageInput = document.getElementById('message-input');
        const chatTitle = document.getElementById('chat-title');
        
        // --- State ---
        let currentUser = null;
        let selectedUserId = null;
        let socket;
        
        // --- Authentication & Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                // Decode token to get user info
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload.user;
                
                welcomeMessage.textContent = `Welcome, ${currentUser.username}`;
                setupSocket(token);

                if (currentUser.isAdmin) {
                    adminPanel.style.display = 'block';
                    fetchUsers(token);
                } else {
                    // For regular users, set the admin as the recipient
                    chatTitle.textContent = "Chat with Admin";
                    messageInputArea.style.display = 'flex';
                    selectedUserId = 'admin'; // A placeholder to fetch history with admin
                    fetchChatHistory(token);
                }

            } catch (e) {
                console.error("Invalid token:", e);
                logout();
            }
        });

        function setupSocket(token) {
            socket = io({ auth: { token } });

            socket.on('receiveMessage', (message) => {
                // Only display message if it's part of the currently active chat
                const relevantUser = currentUser.isAdmin ? selectedUserId : message.senderId;
                if (message.senderId === relevantUser || message.recipientId === relevantUser) {
                    displayMessage(message);
                }
            });

            socket.on('userStatus', ({ userId, online }) => {
                const userElement = document.querySelector(`li[data-user-id="${userId}"] .status-dot`);
                if (userElement) {
                    userElement.classList.toggle('online', online);
                }
            });

             socket.on('onlineUsers', (onlineUserIds) => {
                const userElements = userList.querySelectorAll('li');
                userElements.forEach(li => {
                    const dot = li.querySelector('.status-dot');
                    if (dot) {
                        dot.classList.toggle('online', onlineUserIds.includes(li.dataset.userId));
                    }
                });
            });
        }

        // --- Core Functions ---
        async function fetchUsers(token) {
            try {
                const res = await fetch('/api/users', { headers: { 'x-auth-token': token } });
                if (!res.ok) throw new Error('Failed to fetch users');
                const users = await res.json();
                
                userList.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.dataset.userId = user._id;
                    li.dataset.username = user.username;
                    li.innerHTML = `
                        <span>${user.username}</span>
                        <span class="status-dot"></span>
                    `;
                    li.onclick = () => selectUser(li);
                    userList.appendChild(li);
                });
            } catch (error) {
                console.error(error);
            }
        }
        
        function selectUser(li) {
            // Deselect previous
            const currentSelected = document.querySelector('#user-list li.selected');
            if (currentSelected) {
                currentSelected.classList.remove('selected');
            }
            // Select new
            li.classList.add('selected');
            selectedUserId = li.dataset.userId;
            chatTitle.textContent = `Chat with ${li.dataset.username}`;
            messageInputArea.style.display = 'flex';
            
            fetchChatHistory(localStorage.getItem('token'));
        }
        
        async function fetchChatHistory(token) {
            if (!selectedUserId) return;
            messagesBox.innerHTML = '<p>Loading history...</p>';
            try {
                const res = await fetch(`/api/messages/${selectedUserId}`, {
                    headers: { 'x-auth-token': token }
                });
                const messages = await res.json();
                messagesBox.innerHTML = '';
                messages.forEach(displayMessage);
            } catch (error) {
                console.error("Failed to fetch chat history:", error);
                messagesBox.innerHTML = '<p>Could not load history.</p>';
            }
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text && selectedUserId && socket) {
                const recipientId = currentUser.isAdmin ? selectedUserId : null; // Server will know it's for admin if null
                
                const message = {
                    recipientId: recipientId,
                    text: text,
                    // These will be added on the server, but useful for instant display
                    senderId: currentUser.id,
                    timestamp: new Date().toISOString()
                };

                socket.emit('sendMessage', message);
                displayMessage(message, true); // Instantly display sent message
                messageInput.value = '';
            }
        }

        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function displayMessage(message, isInstant = false) {
             // If this is an instantly displayed message, it's always 'sent'
            const messageType = isInstant ? 'sent' : (message.senderId === currentUser.id ? 'sent' : 'received');

            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', messageType);

            const textP = document.createElement('p');
            textP.classList.add('msg-text');
            textP.textContent = message.text;
            
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('msg-time');
            timeSpan.textContent = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            msgDiv.appendChild(textP);
            msgDiv.appendChild(timeSpan);
            messagesBox.appendChild(msgDiv);
            
            // Auto-scroll to the bottom
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>

