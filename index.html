<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce7f3; /* Light pink background */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .scrollbar-w-2::-webkit-scrollbar {
            width: 0.5rem;
        }
        .scrollbar-w-2::-webkit-scrollbar-thumb {
            background-color: #fbcfe8; /* Soft pink scrollbar thumb */
            border-radius: 0.25rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen flex items-center justify-center p-4">

    <div id="auth-container" class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 space-y-6 transform transition-all duration-300">
        <h2 class="text-3xl font-bold text-center text-pink-700">Welcome</h2>
        <p class="text-sm text-center text-gray-600">Log in to view your chats or sign up to get started.</p>
        <div id="status-message" class="hidden p-3 text-sm rounded-lg text-center font-semibold transition-all duration-300"></div>
        <form id="auth-form" class="space-y-4">
            <div>
                <input type="email" id="auth-email" placeholder="Email" class="w-full px-4 py-3 rounded-lg border border-pink-200 focus:ring-pink-500 focus:border-pink-500 transition-colors duration-200">
            </div>
            <div>
                <input type="password" id="auth-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-pink-200 focus:ring-pink-500 focus:border-pink-500 transition-colors duration-200">
            </div>
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                <button type="button" id="login-btn" class="w-full px-4 py-3 bg-pink-600 text-white font-semibold rounded-lg shadow-md hover:bg-pink-700 transition-colors transform hover:scale-105">Log In</button>
                <button type="button" id="signup-btn" class="w-full px-4 py-3 bg-pink-200 text-pink-800 font-semibold rounded-lg hover:bg-pink-300 transition-colors transform hover:scale-105">Sign Up</button>
            </div>
        </form>
    </div>

    <div id="app-container" class="hidden bg-white rounded-3xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col md:flex-row overflow-hidden transform transition-all duration-300">
        
        <!-- Owner View: User List -->
        <div id="user-list-container" class="hidden w-full md:w-1/3 border-r border-pink-200 bg-pink-50 flex flex-col">
            <header class="p-4 border-b border-pink-200 flex items-center justify-between bg-white shadow-sm">
                <h3 class="text-lg font-semibold text-pink-700">Conversations</h3>
                <span id="owner-id-display" class="text-xs text-pink-500 px-2 py-1 bg-pink-200 rounded-full"></span>
                <button id="logout-btn-owner" class="px-3 py-1 bg-pink-200 rounded-lg text-sm text-pink-700 hover:bg-pink-300 transition-colors">Log Out</button>
            </header>
            <div id="user-list" class="flex-1 overflow-y-auto scrollbar-w-2 p-2">
                <!-- User items will be rendered here -->
            </div>
        </div>

        <!-- User View: Chat Interface -->
        <div id="chat-container" class="w-full md:w-2/3 flex flex-col">
            <header class="p-4 border-b border-pink-200 flex items-center justify-between bg-white shadow-sm">
                 <button id="back-to-list-btn" class="text-pink-500 hover:text-pink-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h3 id="chat-header" class="text-lg font-semibold text-pink-700 flex-1 ml-4"></h3>
                <span id="user-id-display" class="text-xs text-pink-500 px-2 py-1 bg-pink-200 rounded-full"></span>
                <button id="logout-btn-user" class="px-3 py-1 bg-pink-200 rounded-lg text-sm text-pink-700 hover:bg-pink-300 transition-colors">Log Out</button>
            </header>
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-w-2">
                <!-- Messages will be rendered here -->
            </div>
            <div id="chat-form-container" class="p-4 border-t border-pink-200 bg-white">
                <form id="message-form" class="flex space-x-2">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 px-4 py-3 rounded-full border border-pink-300 focus:ring-pink-500 focus:border-pink-500">
                    <button type="submit" class="bg-pink-600 text-white p-3 rounded-full shadow-md hover:bg-pink-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.945a.75.75 0 0 0 .926.94 60.599 60.599 0 0 0 5.432 8.786.75.75 0 0 0 1.05.158l9.743-9.743a.75.75 0 0 0 0-1.06L7.544 2.247a.75.75 0 0 0-.94.926l2.432 7.945a60.599 60.599 0 0 0-5.432 8.786.75.75 0 0 0-1.05.158l-9.743 9.743a.75.75 0 0 0 0 1.06z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="spinner"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Global variables for Firebase config and App ID
        const firebaseConfig = {
          apiKey: "AIzaSyCfFAoT_zRgFu5CY5xDnzcalnrPvNHD1Xg",
          authDomain: "my-private-chat-app-b99aa.firebaseapp.com",
          projectId: "my-private-chat-app-b99aa",
          storageBucket: "my-private-chat-app-b99aa.firebasestorage.app",
          messagingSenderId: "454442482048",
          appId: "1:454442482048:web:a198a9fe7054e225bb2965",
          measurementId: "G-J583NVS01Z"
        };
        const appId = 'default-app-id'; // This is a placeholder for the real Canvas app ID

        // ** IMPORTANT **
        // Replace 'YOUR_OWNER_ID_HERE' with your actual Firebase User UID
        // You can get this by signing up on the app, copying the ID from the header,
        // and pasting it here.
        const OWNER_ID = 'eXuhGfVITxYgVy5gB55PdX5YCl62';

        // Firestore & Auth imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, orderBy, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase debug log level
        setLogLevel('debug');
        
        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const statusMessage = document.getElementById('status-message');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtnUser = document.getElementById('logout-btn-user');
        const logoutBtnOwner = document.getElementById('logout-btn-owner');
        const userIdDisplay = document.getElementById('user-id-display');
        const ownerIdDisplay = document.getElementById('owner-id-display');
        const userListContainer = document.getElementById('user-list-container');
        const userList = document.getElementById('user-list');
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribeMessages = null;

        // --- Functions ---
        
        function showMessage(text, isError = false) {
            statusMessage.textContent = text;
            statusMessage.className = `p-3 text-sm rounded-lg text-center font-semibold ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            statusMessage.classList.remove('hidden');
        }

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        async function createUserData(user) {
            const userRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
            try {
                await setDoc(userRef, {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    isOwner: user.uid === OWNER_ID
                }, { merge: true });
                console.log("User data written to Firestore.");
            } catch (e) {
                console.error("Error creating user data:", e);
                // We don't block login on this error, as the user can still proceed.
            }
        }

        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-sm text-sm break-words ${msg.senderId === currentUser.uid ? 'bg-pink-600 text-white ml-auto rounded-br-none' : 'bg-pink-200 text-gray-800 rounded-bl-none'}`;
                messageElement.textContent = msg.text;
                messagesContainer.appendChild(messageElement);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function listenForMessages(chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Unsubscribe from previous chat
            }
            const messagesRef = collection(db, `artifacts/${appId}/private_messages/${chatId}/messages`);
            const q = query(messagesRef, orderBy('createdAt'));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                // Display user-friendly error
            });
        }
        
        async function loadOwnerDashboard() {
            userListContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            ownerIdDisplay.textContent = `ID: ${currentUser.uid}`;
            
            const usersRef = collection(db, `artifacts/${appId}/users`);
            const q = query(usersRef, orderBy('createdAt'));
            
            onSnapshot(q, async (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Found users in database:", users); // <--- DEBUGGING LINE
                userList.innerHTML = '';
                
                for (const user of users) {
                    if (user.id === OWNER_ID) continue; // Skip the owner's own profile

                    const userItem = document.createElement('div');
                    userItem.className = 'p-4 border-b border-pink-200 cursor-pointer hover:bg-pink-100 transition-colors rounded-lg flex justify-between items-center';
                    userItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center text-white font-bold text-sm">U</div>
                            <div>
                                <p class="font-semibold text-pink-700">User</p>
                                <p class="text-sm text-gray-500 truncate w-40">ID: ${user.id}</p>
                            </div>
                        </div>
                    `;
                    userItem.addEventListener('click', () => {
                        // Switch to the chat view for this user
                        chatContainer.classList.remove('hidden');
                        userListContainer.classList.add('hidden');
                        const chatId = currentUser.uid > user.id ? `${currentUser.uid}_${user.id}` : `${user.id}_${currentUser.uid}`;
                        chatHeader.textContent = `Chat with User`;
                        userIdDisplay.textContent = `ID: ${user.id}`;
                        listenForMessages(chatId);
                    });
                    userList.appendChild(userItem);
                }
            });
        }

        async function loadUserChat() {
            userListContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            userIdDisplay.textContent = `ID: ${currentUser.uid}`;
            chatHeader.textContent = 'Your private chat';

            const chatId = currentUser.uid > OWNER_ID ? `${currentUser.uid}_${OWNER_ID}` : `${OWNER_ID}_${currentUser.uid}`;
            listenForMessages(chatId);
            
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (text === '') return;
                
                const messagesRef = collection(db, `artifacts/${appId}/private_messages/${chatId}/messages`);
                try {
                    await addDoc(messagesRef, {
                        text,
                        senderId: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (e) {
                    console.error("Error sending message:", e);
                    showMessage("Error sending message.", true);
                }
            });
        }
        
        // --- Event Listeners ---
        
        authForm.addEventListener('submit', (e) => e.preventDefault());
        
        backToListBtn.addEventListener('click', () => {
             loadOwnerDashboard();
        });

        loginBtn.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            showLoading();
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                showMessage("Logged in successfully!");
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                showMessage("Login failed. Please check your email and password.", true);
            } finally {
                hideLoading();
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            if (password.length < 6) {
                showMessage("Password must be at least 6 characters.", true);
                return;
            }
            showLoading();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createUserData(userCredential.user);
                showMessage("Account created successfully! You can now log in.");
            } catch (error) {
                console.error("Sign up failed:", error.code, error.message);
                showMessage("Sign up failed. A user with that email may already exist or the password is too weak.", true);
            } finally {
                hideLoading();
            }
        });

        logoutBtnUser.addEventListener('click', async () => {
            await signOut(auth);
            showMessage("Logged out successfully.");
        });

        logoutBtnOwner.addEventListener('click', async () => {
            await signOut(auth);
            showMessage("Logged out successfully.");
        });

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                if (currentUser.uid === OWNER_ID) {
                    await loadOwnerDashboard();
                } else {
                    await loadUserChat();
                }
                hideLoading(); // Hide loading when auth state is determined
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                authForm.reset();
                hideLoading(); // Hide loading when auth state is determined
            }
        });

        // Event listener for sending messages
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '') return;
            
            const recipientId = (currentUser.uid === OWNER_ID) ? userIdDisplay.textContent.replace('ID: ', '') : OWNER_ID;
            const chatId = currentUser.uid > recipientId ? `${currentUser.uid}_${recipientId}` : `${recipientId}_${currentUser.uid}`;
            const messagesRef = collection(db, `artifacts/${appId}/private_messages/${chatId}/messages`);

            try {
                await addDoc(messagesRef, {
                    text,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                messageInput.value = '';
            } catch (e) {
                console.error("Error sending message:", e);
                showMessage("Error sending message.", true);
            }
        });
        
        // Initial state
        showLoading(); // Show loading when the page first loads
    </script>
</body>
</html>
